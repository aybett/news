{% extends 'base.html' %}
{% block content %}
  <h2>{{ news.title }}</h2>
  <p class="text-muted">{{ news.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
  <p>{{ news.content }}</p>
  {% if news.image %}
    {% set ext = news.image.split('.')[-1].lower() %}
    <div class="mb-3">
      {% if ext in ['png','jpg','jpeg','gif','bmp','webp'] %}
        <a href="{{ url_for('static', filename='uploads/' ~ news.image) }}" target="_blank">
          <img src="{{ url_for('static', filename='uploads/' ~ news.image) }}" class="img-fluid full-bleed" alt="{{ news.title }}">
        </a>
      {% elif ext == 'pdf' %}
        <object data="{{ url_for('static', filename='uploads/' ~ news.image) }}" type="application/pdf" width="100%" height="600">
          <a href="{{ url_for('static', filename='uploads/' ~ news.image) }}" target="_blank">PDF'i aç</a>
        </object>
      {% else %}
        <a href="{{ url_for('static', filename='uploads/' ~ news.image) }}" target="_blank" class="btn btn-outline-primary">
          Dosyayı indir / aç ({{ news.image }})
        </a>
      {% endif %}
    </div>
  {% endif %}

  <div class="mb-3">
    {% if current_user.is_authenticated and current_user.role == 'editor' %}
      <a class="btn btn-sm btn-secondary" href="{{ url_for('admin.edit_news', id=news.id) }}">Düzenle</a>
      <a class="btn btn-sm btn-danger" href="{{ url_for('admin.delete_news', id=news.id) }}">Sil</a>
    {% endif %}
  </div>

  <h4>Yorumlar</h4>
  {% for c in comments %}
    <div class="border rounded p-3 mb-2">
      <div class="d-flex align-items-start">
        <div class="me-3">
          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:40px;height:40px;font-weight:600;">
            {{ c.user.username[0]|upper if c.user and c.user.username }}
          </div>
        </div>
        <div class="flex-grow-1">
          <div>
            <strong>
              {% if c.user %}
                <a href="{{ url_for('auth.user_profile', user_id=c.user.id) }}">{{ c.user.username }}</a>
              {% else %}
                Misafir
              {% endif %}
            </strong>
            <small class="text-muted ms-2">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            {% if current_user.is_authenticated and current_user.role == 'editor' %}
              <a class="btn btn-sm btn-danger ms-2" href="{{ url_for('admin.delete_comment', id=c.id) }}">Yorumu Sil</a>
            {% endif %}
          </div>
          <div class="mt-2">{{ c.content }}</div>

          <!-- replies -->
          {% for r in c.replies %}
            <div class="mt-3 ms-4 p-2 border rounded">
              <strong><a href="{{ url_for('auth.user_profile', user_id=r.user.id) }}">{{ r.user.username }}</a></strong>
              <small class="text-muted ms-2">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
              <div class="mt-1">{{ r.content }}</div>
              {% if current_user.is_authenticated and current_user.role == 'editor' %}
                <a class="btn btn-sm btn-danger ms-2" href="{{ url_for('admin.delete_comment', id=r.id) }}">Yorumu Sil</a>
              {% endif %}
            </div>
          {% endfor %}

          <!-- reply form -->
          {% if current_user.is_authenticated %}
            <form method="post" class="mt-3">
              <input type="hidden" name="parent_id" value="{{ c.id }}">
              <div class="mb-2">
                <textarea class="form-control" name="content" rows="2" placeholder="Cevap yaz..." required></textarea>
              </div>
              <button class="btn btn-sm btn-outline-primary" type="submit">Cevapla</button>
            </form>
          {% endif %}

        </div>
      </div>
    </div>
  {% else %}
    <p>Henüz yorum yok.</p>
  {% endfor %}

  {% if current_user.is_authenticated %}
  <form method="post">
    <div class="mb-3">
      <textarea class="form-control" name="content" rows="3" required></textarea>
    </div>
    <button class="btn btn-primary" type="submit">Yorum Yap</button>
  </form>
  {% elif session.get('guest') %}
    <p>Yorum yapmak için kayıt ol veya giriş yap.</p>
  {% else %}
    <p><a href="{{ url_for('auth.login') }}">Giriş</a> yaparak yorum yazabilirsiniz.</p>
  {% endif %}
{% endblock %}
